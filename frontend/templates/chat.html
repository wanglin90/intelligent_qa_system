{% extends "base.html" %}

{% block title %}æ™ºèƒ½é—®ç­” - æ™ºèƒ½æ–‡æ¡£é—®ç­”ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card card-custom h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-comments"></i> æ™ºèƒ½å¯¹è¯
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="chatContainer" class="chat-container">
                    <div class="message bot">
                        <div class="message-content">
                            <i class="fas fa-robot text-primary"></i>
                            ä½ å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½æ–‡æ¡£åŠ©æ‰‹ã€‚è¯·å…ˆä¸Šä¼ æ–‡æ¡£ï¼Œç„¶åå°±å¯ä»¥å‘æˆ‘æé—®äº†ã€‚æˆ‘ä¼šåŸºäºæ‚¨ä¸Šä¼ çš„æ–‡æ¡£å†…å®¹æ¥å›ç­”é—®é¢˜ã€‚
                        </div>
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <i class="fas fa-robot"></i> æ­£åœ¨æ€è€ƒä¸­...
                </div>
            </div>
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" 
                           placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." maxlength="500">
                    <button class="btn btn-primary" id="sendButton">
                        <i class="fas fa-paper-plane"></i> å‘é€
                    </button>
                </div>
                <small class="text-muted mt-2 d-block">
                    æç¤ºï¼šè¯·ç¡®ä¿å·²ä¸Šä¼ ç›¸å…³æ–‡æ¡£ï¼Œé—®é¢˜è¶Šå…·ä½“ï¼Œå›ç­”è¶Šå‡†ç¡®
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card card-custom mb-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar"></i> ç³»ç»ŸçŠ¶æ€
                </h6>
            </div>
            <div class="card-body">
                <div id="systemStatus">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>åç«¯æœåŠ¡:</span>
                        <span id="backendStatus" class="badge bg-secondary">æ£€æŸ¥ä¸­...</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>æ–‡æ¡£æ•°é‡:</span>
                        <span id="docCount" class="badge bg-secondary">-</span>
                    </div>
                    <button class="btn btn-sm btn-outline-primary w-100" id="refreshStatus">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°çŠ¶æ€
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card card-custom mb-3">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-tools"></i> å¿«é€Ÿæ“ä½œ
                </h6>
            </div>
            <div class="card-body">
                <button class="btn btn-sm btn-outline-success w-100 mb-2" onclick="location.href='/upload'">
                    <i class="fas fa-upload"></i> ä¸Šä¼ æ–‡æ¡£
                </button>
                <button class="btn btn-sm btn-outline-danger w-100 mb-2" id="clearChat">
                    <i class="fas fa-trash"></i> æ¸…ç©ºå¯¹è¯
                </button>
                <button class="btn btn-sm btn-outline-info w-100" onclick="location.href='/manage'">
                    <i class="fas fa-cog"></i> æ–‡æ¡£ç®¡ç†
                </button>
            </div>
        </div>
        
        <div class="card card-custom">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb"></i> ä½¿ç”¨æç¤º
                </h6>
            </div>
            <div class="card-body">
                <ul class="small mb-0">
                    <li>æ”¯æŒPDFã€Wordã€TXTæ ¼å¼æ–‡æ¡£</li>
                    <li>é—®é¢˜è¶Šå…·ä½“ï¼Œç­”æ¡ˆè¶Šå‡†ç¡®</li>
                    <li>å¯ä»¥è¿›è¡Œå¤šè½®å¯¹è¯</li>
                    <li>ç³»ç»Ÿä¼šæ˜¾ç¤ºç­”æ¡ˆæ¥æºå’Œç½®ä¿¡åº¦</li>
                    <li>å»ºè®®æ–‡æ¡£å†…å®¹ç›¸å…³ä¸”å®Œæ•´</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let sessionId = 'session_' + Date.now();

$(document).ready(function() {
    // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
    checkSystemStatus();
    
    // å‘é€æ¶ˆæ¯
    $('#sendButton').click(sendMessage);
    $('#messageInput').keypress(function(e) {
        if (e.which === 13) {
            sendMessage();
        }
    });
    
    // æ¸…ç©ºå¯¹è¯
    $('#clearChat').click(function() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºå¯¹è¯è®°å½•å—ï¼Ÿ')) {
            clearChat();
        }
    });
    
    // åˆ·æ–°çŠ¶æ€
    $('#refreshStatus').click(checkSystemStatus);
});

function sendMessage() {
    const message = $('#messageInput').val().trim();
    if (!message) return;
    
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    addMessage('user', message);
    $('#messageInput').val('');
    
    // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
    $('#typingIndicator').show();
    $('#sendButton').prop('disabled', true);
    
    // å‘é€åˆ°åç«¯
    $.ajax({
        url: '/api/chat',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            question: message,
            session_id: sessionId
        }),
        success: function(response) {
            $('#typingIndicator').hide();
            $('#sendButton').prop('disabled', false);
            
            if (response.error) {
                addMessage('bot', 'âŒ ' + response.error, true);
            } else {
                addBotMessage(response);
            }
        },
        error: function(xhr) {
            $('#typingIndicator').hide();
            $('#sendButton').prop('disabled', false);
            
            let errorMsg = 'âŒ æŸ¥è¯¢å¤±è´¥';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg += ': ' + xhr.responseJSON.error;
            }
            addMessage('bot', errorMsg, true);
        }
    });
}

function addMessage(type, content, isError = false) {
    const messageDiv = $(`
        <div class="message ${type}">
            <div class="message-content">
                ${type === 'bot' ? '<i class="fas fa-robot text-primary"></i> ' : ''}
                ${content}
            </div>
        </div>
    `);
    
    if (isError) {
        messageDiv.find('.message-content').addClass('text-danger border-danger');
    }
    
    $('#chatContainer').append(messageDiv);
    $('#chatContainer').scrollTop($('#chatContainer')[0].scrollHeight);
}

function addBotMessage(response) {
    let content = response.answer;
    
    // æ·»åŠ å…ƒä¿¡æ¯
    if (response.confidence !== undefined) {
        content += `
            <div class="mt-3">
                <span class="confidence-badge">ç½®ä¿¡åº¦: ${(response.confidence * 100).toFixed(1)}%</span>
                <small class="text-muted ms-2">
                    æ£€ç´¢æ–‡æ¡£: ${response.retrieved_count} ä¸ª | 
                    å¤„ç†æ—¶é—´: ${response.processing_time.toFixed(2)}s
                </small>
            </div>
        `;
    }
    
    // æ·»åŠ æ¥æºä¿¡æ¯
    if (response.sources && response.sources.length > 0) {
        content += '<div class="mt-3"><strong>ğŸ“‹ å¼•ç”¨æ¥æº:</strong>';
        response.sources.forEach((source, index) => {
            content += `
                <div class="source-info">
                    <strong>${index + 1}. ${source.source}</strong> 
                    (ç›¸ä¼¼åº¦: ${(source.score * 100).toFixed(1)}%)
                    <br><small class="text-muted">${source.content_preview}</small>
                </div>
            `;
        });
        content += '</div>';
    }
    
    addMessage('bot', content);
}

function clearChat() {
    $.ajax({
        url: '/api/memory/clear',
        method: 'POST',
        success: function(response) {
            $('#chatContainer').empty();
            addMessage('bot', 'âœ… å¯¹è¯è®°å½•å·²æ¸…ç©ºã€‚ä½ å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½æ–‡æ¡£åŠ©æ‰‹ï¼Œè¯·å‘æˆ‘æé—®ã€‚');
            sessionId = 'session_' + Date.now();
        },
        error: function() {
            alert('æ¸…ç©ºå¯¹è¯å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
}

function checkSystemStatus() {
    $('#refreshStatus').prop('disabled', true);
    
    // æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
    $.ajax({
        url: '/api/health',
        method: 'GET',
        success: function(response) {
            $('#backendStatus').removeClass('bg-secondary bg-danger').addClass('bg-success').text('æ­£å¸¸');
        },
        error: function() {
            $('#backendStatus').removeClass('bg-secondary bg-success').addClass('bg-danger').text('å¼‚å¸¸');
        }
    });
    
    // æ£€æŸ¥æ–‡æ¡£æ•°é‡
    $.ajax({
        url: '/api/documents',
        method: 'GET',
        success: function(response) {
            $('#docCount').removeClass('bg-secondary').addClass('bg-info').text(response.total_documents + ' ä¸ª');
        },
        error: function() {
            $('#docCount').removeClass('bg-secondary').addClass('bg-warning').text('è·å–å¤±è´¥');
        },
        complete: function() {
            $('#refreshStatus').prop('disabled', false);
        }
    });
}
</script>
{% endblock %}